<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>

  <body>
    <button onclick="speak()">button</button>
    <p id="status">Not Connected</p>
    <p id="transcript"></p>
    <script>
      const speak = async () => {
        navigator.mediaDevices
          .getUserMedia({
            audio: true,
          })
          .then((stream) => {
            console.log({
              stream,
            });
            if (!MediaRecorder.isTypeSupported("audio/webm"))
              return alert("Browser not supported");
            const mediaRecorder = new MediaRecorder(stream, {
              mimeType: "audio/webm",
            });
            const socket = new WebSocket("wss://api.deepgram.com/v1/listen", [
              "token",
              "79c607c5513cd211a99ca6d04fc927b52480f84f",
            ]);
            socket.onopen = () => {
              document.querySelector("#status").textContent = "Connected";
              console.log({
                event: "onopen",
              });
              mediaRecorder.addEventListener("dataavailable", async (event) => {
                if (event.data.size > 0 && socket.readyState == 1) {
                  socket.send(event.data);
                }
              });
              mediaRecorder.start(1000);
            };

            socket.onmessage = async (message) => {
              const received = JSON.parse(message.data);
              const transcript = received.channel.alternatives[0].transcript;
              if (transcript && received.is_final) {
                console.log(transcript);
                document.querySelector("#transcript").textContent +=
                  transcript + " ";
                //   ==================
                await fetch("https://sore-gilet-bass.cyclic.app/", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    query: `
                    query Chat($question: String) {
                        chat(question: $question)
                      }
      `,
                    variables: {
                      question: transcript,
                    },
                  }),
                })
                  .then((res) => res.json())
                  .then(async (result) => {
                    console.log(result.data.chat.trim());
                  });
                //   ==================
              }
            };

            socket.onclose = () => {
              console.log({
                event: "onclose",
              });
            };

            socket.onerror = (error) => {
              console.log({
                event: "onerror",
                error,
              });
            };
          });
      };
    </script>
  </body>
</html>
